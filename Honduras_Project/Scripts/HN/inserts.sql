insert into VW_IMPORT_AGENT (AGENT_CODE,IND_IMPORT,AGENT_NAME,IND_INACTIVE) select cast(replace(agente,' ','') as integer) AGENT_CODE,0 IND_IMPORT,nombre AGENT_NAME, IND_INACTIVE from (select  agente, nombre,IND_INACTIVE ,RN = ROW_NUMBER()OVER(PARTITION BY agente ORDER BY agente)from (SELECT  distinct  agente, nombre,Case when (DELETED='S') then 1 else 0 end ind_inactive FROM vw_origin_agentes) ff where agente!=0  ) ll where RN=1;;

insert into VW_IMPORT_AGENT_PERSONS (AGENT_CODE,PERSON_NAME,NATIONALITY_COUNTRY_CODE,IND_COMPANY,RESIDENCE_COUNTRY_CODE,ADDRESS_STREET) select cast(replace(agente,' ','') as integer) AGENT_CODE,nombre PERSON_NAME,'HN' NATIONALITY_COUNTRY_CODE,0 IND_COMPANY,'HN' RESIDENCE_COUNTRY_CODE,direccion ADDRESS_STREET from (select  agente, nombre,direccion,pais ,RN = ROW_NUMBER()OVER(PARTITION BY agente ORDER BY agente)from (SELECT   agente     , nombre      ,Case when (direccion='') then 'Dirección a capturar' else direccion end direccion,'HN' as pais FROM dbo.vw_origin_agentes) ff where agente!=0  ) ll where RN=1;;

insert into VW_IMPORT_MARK_VIENNA_CLASSES(  FILE_SEQ, FILE_TYPE, FILE_SERIES, FILE_NBR, VIENNA_EDITION_CODE, VIENNA_CATEGORY, VIENNA_DIVISION, VIENNA_SECTION) SELECT  file_SEQ, FILE_TYPE, FILE_SERIES, file_NBR,	  cast(0 as numeric) VIENNA_EDITION_CODE,cast(substring(replace(replace(ccv,' ',''),'.',''),1,2) as numeric) VIENNA_CATEGORY   ,cast(case when substring(replace(replace(ccv,' ',''),'.',''),3,2) is null or substring(replace(replace(ccv,' ',''),'.',''),3,2)='' then 1 else substring(replace(replace(ccv,' ',''),'.',''),3,2) end as numeric)  VIENNA_DIVISION   ,cast(case when isnumeric(substring(replace(replace(ccv,' ',''),'.',''),5,2))=0 then null else substring(replace(replace(ccv,' ',''),'.',''),5,2) end as numeric)   VIENNA_SECTION  FROM vw_origin_ccvs cc, vw_marcas2 mm where cc.NRO_SOLICI=mm.NRO_SOLICI AND CCV is not null AND CCV !='';;

insert into VW_IMPORT_MARK_REPRS (  FILE_SEQ, FILE_TYPE, FILE_SERIES, FILE_NBR,AGENT_CODE,REPRESENTATIVE_TYPE,PERSON_NAME,NATIONALITY_COUNTRY_CODE,IND_COMPANY,RESIDENCE_COUNTRY_CODE,ADDRESS_STREET) select om.FILE_SEQ,om.FILE_TYPE,om.FILE_SERIES,om.FILE_NBR,cast(replace(ll.agente,' ','') as integer) AGENT_CODE,'AG' REPRESENTATIVE_TYPE,nombre PERSON_NAME,'HN' NATIONALITY_COUNTRY_CODE,0 IND_COMPANY,'HN' RESIDENCE_COUNTRY_CODE,direccion ADDRESS_STREET from (select  agente, nombre,direccion,pais ,RN = ROW_NUMBER()OVER(PARTITION BY agente ORDER BY agente)from (SELECT   agente     , nombre      ,Case when (direccion='') then 'Dirección a capturar' else direccion end direccion,'HN' as pais FROM dbo.vw_origin_agentes) ff where agente!=0  ) ll inner join vw_origin_marca mm on ll.agente=mm.agente inner join vw_marcas2 om on mm.nro_solici=om.nro_solici where ll.RN=1;;

with cte as (SELECT pet. rowNum       , cast(doc_ser as numeric)  doc_ser    , doc_seq       , cast(doc_nbr as numeric)  doc_nbr         ,pet. NUM_SERIE       , 0 as ind_import , TIPO_PETI userdoc_TYPE , 1 as law_code       ,        convert(datetime, case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) FILING_DATE       ,          convert(datetime,case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) RECEPTION_DATE 		,case when isnumeric(NRO_RESOL)=1 then 'Nro. resolucion: '+ NRO_RESOL else '' end +          case when len(observacio)>0 then 'observaciones: '+ cast( OBSERVACIO as varchar(max)) else '' end  notes   , NOMBRE PERSON_NAME ,case when (pais is null or pais='') then 'HN' else  PAIS end NATIONALITY_COUNTRY_CODE ,case when(len( LUGAR)>2 and len(pais)=2 ) then pais when len(lugar)=2 then lugar else 'HN' end RESIDENCE_COUNTRY_CODE ,case when (direccion is null or direccion='') then 'Falta direccion' else  DIRECCION end ADDRESS_STREET ,4 capture_user_id ,getdate() capture_date       , STATUS_RES       , STAT_DESDE       , AGENTE       , CALIDAD       , qUien       , CUAL       , NRO_RESOL       , OBSERVACIO       , LEY       , cambrep       ,pet. Deleted 	  ,RN = ROW_NUMBER()OVER(PARTITION BY doc_seq,doc_ser,doc_nbr ORDER BY doc_ser,doc_nbr)   FROM   vw_PETICI pet,   VW_ORIGIN_nuenoms nom ,  VW_ORIGIN_TITULAR titu     where pet.num_serie is not null and pet.num_serie !='' and len(pet.num_serie)>5   and pet.num_serie=nom.NUM_SERIE and nom.titular=titu.TITULAR)   insert into   VW_IMPORT_USERDOC (    USERDOC_SEQ       , USERDOC_SERIES       , USERDOC_NBR       , IND_IMPORT       , USERDOC_TYPE       , LAW_CODE       , FILING_DATE       , RECEPTION_DATE       , NOTES       , PERSON_NAME         , NATIONALITY_COUNTRY_CODE       , RESIDENCE_COUNTRY_CODE       , ADDRESS_STREET       , CAPTURE_USER_ID       , CAPTURE_DATE  )   select case when rn=1 then DOC_SEQ else doc_seq +'-'+cast(rn as varchar) end userdoc_seq       ,doc_ser USERDOC_SERIES       ,doc_nbr USERDOC_NBR       , IND_IMPORT       , USERDOC_TYPE       , LAW_CODE       , FILING_DATE       , RECEPTION_DATE       , NOTES       , PERSON_NAME         , NATIONALITY_COUNTRY_CODE       , RESIDENCE_COUNTRY_CODE       , ADDRESS_STREET       , CAPTURE_USER_ID       , CAPTURE_DATE from cte ;;
  
with cte as (SELECT  rowNum      ,NRO_SOLICI      ,file_ser      ,file_seq      ,file_nbr      ,NUM_SERIE      ,doc_ser      ,doc_seq      ,doc_nbr      ,Deleted	  ,RN = ROW_NUMBER()OVER(PARTITION BY doc_seq,doc_ser,doc_nbr ORDER BY doc_ser,doc_nbr)  FROM vw_PETIREG)  insert into vw_import_userdoc_files  select     case when rn=1 then DOC_SEQ else doc_seq +'-'+cast(rn as varchar) end userdoc_seq       ,  cast(doc_ser as numeric) USERDOC_SERIES       ,cast(doc_nbr as numeric) USERDOC_NBR      ,file_seq	  ,1 FILE_TYPE	  ,cast(file_ser as numeric)      ,cast(file_nbr as numeric) from cte where num_serie!='0000000000' and isnumeric(file_ser)=1	  and cast(cast(doc_seq as varchar)+cast(doc_ser as varchar)+cast(doc_nbr as varchar) as varchar) in (select 	  cast(cast(userdoc_seq as varchar)+cast(userdoc_series as varchar)+cast(userdoc_nbr as varchar) as varchar) from vw_import_userdoc);;

with cte as (SELECT pet. rowNum       ,cast(doc_ser as numeric)  doc_ser    , doc_seq       , cast(doc_nbr as numeric)  doc_nbr     ,pet. NUM_SERIE       , 0 as ind_import , TIPO_PETI userdoc_TYPE , 1 as law_code       ,        convert(datetime, case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) FILING_DATE       ,'1' ind_service,          convert(datetime,case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) RECEPTION_DATE 		,case when isnumeric(NRO_RESOL)=1 then 'Nro. resolucion: '+ NRO_RESOL else '' end +          case when len(observacio)>0 then 'observaciones: '+ cast( OBSERVACIO as varchar(max)) else '' end  notes   , NOMBRE PERSON_NAME ,case when (pais is null or pais='') then 'HN' else  PAIS end NATIONALITY_COUNTRY_CODE ,case when(len( LUGAR)>2 and len(pais)=2 ) then pais when len(lugar)=2 then lugar else 'HN' end RESIDENCE_COUNTRY_CODE ,case when (direccion is null or direccion='') then 'Falta direccion' else  DIRECCION end ADDRESS_STREET ,4 capture_user_id ,getdate() capture_date       , STATUS_RES       , STAT_DESDE       , AGENTE       , CALIDAD       , qUien       , CUAL       , NRO_RESOL       , OBSERVACIO       , LEY       , cambrep       ,pet. Deleted 	  ,RN = ROW_NUMBER()OVER(PARTITION BY doc_seq,doc_ser,doc_nbr ORDER BY doc_ser,doc_nbr)   FROM   vw_PETICI pet,   VW_ORIGIN_nuenoms nom ,  VW_ORIGIN_TITULAR titu     where pet.num_serie is not null and pet.num_serie !='' and len(pet.num_serie)>5   and pet.num_serie=nom.NUM_SERIE and nom.titular=titu.TITULAR)    insert into VW_IMPORT_USERDOC_OWNERS ( userdoc_seq,[USERDOC_SERIES      ,[USERDOC_NBR      ,[IND_SERVICE      ,[PERSON_NAME      ,[NATIONALITY_COUNTRY_CODE      ,[RESIDENCE_COUNTRY_CODE      ,[ADDRESS_STREET     )select case when rn=1 then [DOC_SEQ else doc_seq +'-'+cast(rn as varchar) end userdoc_seq      ,doc_ser [USERDOC_SERIES      ,doc_nbr [USERDOC_NBR      ,[IND_SERVICE      ,[PERSON_NAME      ,[NATIONALITY_COUNTRY_CODE      ,[RESIDENCE_COUNTRY_CODE      ,[ADDRESS_STREET from  cte where cast(cast(doc_seq as varchar)+cast(doc_ser as varchar)+cast(doc_nbr as varchar) as varchar) in (select 	  cast(cast(userdoc_seq as varchar)+cast(userdoc_series as varchar)+cast(userdoc_nbr as varchar) as varchar) from vw_import_userdoc);;

with cte as (SELECT pet. rowNum       , cast(doc_ser as numeric)  doc_ser    , doc_seq       , cast(doc_nbr as numeric)  doc_nbr     ,pet. NUM_SERIE       , 0 as ind_import , TIPO_PETI userdoc_TYPE , 1 as law_code       ,        convert(datetime, case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) FILING_DATE       ,'1' ind_service,          convert(datetime,case when isdate(solicitada)=0 then ((case when (substring(pet.num_serie,1,1) not in ('1','2','3','4','5','6','7','8','9','0')) then substring(pet.num_serie,2,4) else substring(pet.num_serie,1,4) end) + substring(solicitada,5,len(solicitada)) ) else solicitada end           + ' '+          case when (substring(hora,1,2) is null or substring(hora,1,2)='  ' or cast(substring(hora,1,2) as numeric)>23)           then '00' else substring(hora,1,2) end           + ':' + case when (substring(hora,3,2) is null or substring(hora,3,2)='  ' or cast(substring(hora,3,2) as numeric)>59) then '00' else substring(hora,3,2) end +           ':' +  case when (substring(hora,5,2) is null or substring(hora,5,2)='  ' or substring(hora,5,2)='' or cast(substring(hora,5,2) as numeric)>59) then '00' else substring(hora,5,2) end,120) RECEPTION_DATE 		,case when isnumeric(NRO_RESOL)=1 then 'Nro. resolucion: '+ NRO_RESOL else '' end +          case when len(observacio)>0 then 'observaciones: '+ cast( OBSERVACIO as varchar(max)) else '' end  notes   , titu.PERSON_NAME ,titu.NATIONALITY_COUNTRY_CODE ,titu.RESIDENCE_COUNTRY_CODE ,titu.ADDRESS_STREET ,4 capture_user_id ,getdate() capture_date       , STATUS_RES       , STAT_DESDE       , AGENTE       , OBSERVACIO       , LEY       , cambrep       ,pet. Deleted 	  ,RN = ROW_NUMBER()OVER(PARTITION BY doc_seq,doc_ser,doc_nbr ORDER BY doc_ser,doc_nbr)   FROM   vw_PETICI pet,  VW_IMPORT_AGENT_PERSONS titu     where pet.num_serie is not null and pet.num_serie !='' and len(pet.num_serie)>5   and AGENTE IS NOT NULL and agente!='' AND ISNUMERIC(AGENTE)=1 AND   CAST(PET.AGENTE AS NUMERIC)=titu.agent_code)   insert into VW_IMPORT_USERDOC_REPRS ( userdoc_seq,USERDOC_SERIES      ,USERDOC_NBR      ,IND_SERVICE         ,REPRESENTATIVE_TYPE      ,PERSON_NAME      ,NATIONALITY_COUNTRY_CODE      ,RESIDENCE_COUNTRY_CODE      ,ADDRESS_STREET     )select case when rn=1 then DOC_SEQ else doc_seq +'-'+cast(rn as varchar) end userdoc_seq      ,doc_ser  USERDOC_SERIES      ,doc_nbr  USERDOC_NBR      ,IND_SERVICE	  ,'AG' REPRESENTATIVE_TYPE      ,PERSON_NAME      ,NATIONALITY_COUNTRY_CODE      ,RESIDENCE_COUNTRY_CODE      ,ADDRESS_STREET from  cte	  	  where cast(cast(doc_seq as varchar)+cast(doc_ser as varchar)+cast(doc_nbr as varchar) as varchar) in (select 	  cast(cast(userdoc_seq as varchar)+cast(userdoc_series as varchar)+cast(userdoc_nbr as varchar) as varchar) from vw_import_userdoc);;	  
  
  





